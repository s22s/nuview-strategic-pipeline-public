name: Automated Backup

on:
  schedule:
    # Run daily at 4:00 AM UTC (after daily scrape)
    - cron: '0 4 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  backup:
    name: üì¶ Create Backup
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì¶ Create Backup Archive
        run: |
          echo -e "\033[94müì¶ Creating backup archive...\033[0m"
          
          # Create backup directory
          BACKUP_DIR="backups/$(date +%Y-%m-%d)"
          mkdir -p "$BACKUP_DIR"
          
          # Copy data files
          cp -r data/ "$BACKUP_DIR/"
          
          # Create metadata file
          cat > "$BACKUP_DIR/backup_metadata.json" << EOF
          {
            "backup_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "git_commit": "$(git rev-parse HEAD)",
            "git_branch": "$(git rev-parse --abbrev-ref HEAD)",
            "backup_type": "automated"
          }
          EOF
          
          # Create compressed archive
          tar -czf "$BACKUP_DIR.tar.gz" -C backups "$(date +%Y-%m-%d)"
          
          # Keep only archives (remove uncompressed)
          rm -rf "$BACKUP_DIR"
          
          echo -e "\033[92m‚úÖ Backup created: $BACKUP_DIR.tar.gz\033[0m"

      - name: üóëÔ∏è Cleanup Old Backups
        run: |
          echo -e "\033[94müóëÔ∏è  Cleaning up old backups...\033[0m"
          
          # Keep only last 30 days of backups
          find backups/ -name "*.tar.gz" -type f -mtime +30 -delete
          
          # Count remaining backups
          BACKUP_COUNT=$(find backups/ -name "*.tar.gz" -type f | wc -l)
          echo -e "\033[92m‚úÖ Cleanup complete. $BACKUP_COUNT backups retained\033[0m"

      - name: üì§ Commit Backup
        run: |
          echo -e "\033[94müì§ Committing backup to repository...\033[0m"
          
          git config --local user.email "bot@nuview.space"
          git config --local user.name "NUVIEW Backup Bot"
          
          git add backups/
          
          if git diff --staged --quiet; then
            echo -e "\033[93m‚ö†Ô∏è  No new backups to commit\033[0m"
            exit 0
          fi
          
          git commit -m "üì¶ Automated backup - $(date +%Y-%m-%d)"
          git push origin main
          
          echo -e "\033[92m‚úÖ Backup committed and pushed\033[0m"

      - name: üìä Backup Report
        run: |
          echo -e "\033[92m"
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë              üì¶ BACKUP COMPLETED SUCCESSFULLY              ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo -e "\033[0m"
          echo ""
          echo "Backup Details:"
          echo "  Date: $(date +%Y-%m-%d)"
          echo "  Time: $(date +%H:%M:%S) UTC"
          echo "  Location: backups/"
          echo ""
          ls -lh backups/*.tar.gz 2>/dev/null | tail -5 || echo "  No backups found"

  verify:
    name: ‚úÖ Verify Backup Integrity
    runs-on: ubuntu-latest
    needs: backup
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîç Verify Latest Backup
        run: |
          echo -e "\033[94müîç Verifying backup integrity...\033[0m"
          
          # Find latest backup
          LATEST_BACKUP=$(ls -t backups/*.tar.gz 2>/dev/null | head -1)
          
          if [ -z "$LATEST_BACKUP" ]; then
            echo -e "\033[91m‚ùå No backups found\033[0m"
            exit 1
          fi
          
          echo "Checking: $LATEST_BACKUP"
          
          # Test archive integrity
          if tar -tzf "$LATEST_BACKUP" > /dev/null 2>&1; then
            echo -e "\033[92m‚úÖ Backup archive is valid\033[0m"
            
            # List contents
            echo ""
            echo "Archive contents:"
            tar -tzf "$LATEST_BACKUP" | head -10
            
            exit 0
          else
            echo -e "\033[91m‚ùå Backup archive is corrupted\033[0m"
            exit 1
          fi

      - name: üì¢ Notify if Backup Failed
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const timestamp = new Date().toISOString();
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            const body = `## üö® Automated Backup Failed
            
            **Status:** ‚ùå FAILED
            **Time:** ${timestamp}
            **Workflow Run:** [View Run](${runUrl})
            
            **Action Required:** Check the workflow logs for details.
            
            ---
            ü§ñ Automated notification from Backup workflow`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Automated Backup Failed',
              body: body,
              labels: ['backup-failure', 'automated']
            });
